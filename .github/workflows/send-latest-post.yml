/* name: Send latest post as newsletter

on:
  workflow_dispatch:

jobs:
  send-latest:
    runs-on: ubuntu-latest

    env:
      SMTP_HOST: ${{ secrets.BREVO_SMTP_HOST }}
      SMTP_PORT: ${{ secrets.BREVO_SMTP_PORT }}
      SMTP_LOGIN: ${{ secrets.BREVO_SMTP_LOGIN }}
      SMTP_PASSWORD: ${{ secrets.BREVO_SMTP_PASSWORD }}
      FROM_EMAIL: ${{ secrets.BREVO_FROM_EMAIL }}
      SITE_BASE_URL: "https://namrataniraula.github.io/velvet-afterthoughts"

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Send latest post
        run: |
          python << 'EOF'
          import os
          import csv
          import smtplib
          from email.mime.text import MIMEText
          import re

          # ----------------------------
          # 1. Find latest post
          # ----------------------------
          posts_dir = "_posts"
          files = sorted([f for f in os.listdir(posts_dir) if f.endswith(".md")])
          if not files:
              print("No posts found.")
              raise SystemExit(0)

          latest = files[-1]
          post_path = os.path.join(posts_dir, latest)
          print("Using latest post:", latest)

          # ----------------------------
          # 2. Read post front matter
          # ----------------------------
          title = "New post"
          with open(post_path, encoding="utf-8") as f:
              lines = f.readlines()

          body_lines = []
          if lines and lines[0].strip() == "---":
              i = 1
              while i < len(lines) and lines[i].strip() != "---":
                  if lines[i].startswith("title:"):
                      title = lines[i].split(":", 1)[1].strip().strip('"').strip("'")
                  i += 1
              body_lines = lines[i+1:]
          else:
              body_lines = lines

          preview = "".join(body_lines[:10]).strip()

          # ----------------------------
          # 3. Build permalink
          # ----------------------------
          basename = os.path.splitext(latest)[0]
          year, month, day, *_ = basename.split("-")
          slug = "-".join(basename.split("-")[3:])
          permalink = f"{os.environ['SITE_BASE_URL']}/{year}/{month}/{day}/{slug}.html"

          email_subject = f"Velvet Afterthoughts â€“ {title}"
          email_body = f"""{title}

{preview}

Read the full piece here:
{permalink}
"""

          # ----------------------------
          # 4. Load subscribers
          # ----------------------------
          recipients = []
          email_re = re.compile(r"^[^@\s]+@[^@\s]+\.[^@\s]+$")
          with open("subscribers.csv") as f:
              reader = csv.DictReader(f)
              for row in reader:
                  raw = (row.get("email") or "").strip()
                  if not raw or raw.startswith("#"):
                      continue
                  if not email_re.match(raw):
                      print("Skipping invalid email:", raw)
                      continue
                  recipients.append(raw)

          print("Loaded subscribers:", len(recipients))
          if not recipients:
              raise SystemExit("No valid subscribers found")

          # ----------------------------
          # 5. Send emails
          # ----------------------------
          smtp_host = os.environ["SMTP_HOST"]
          smtp_port = int(os.environ["SMTP_PORT"])
          smtp_login = os.environ["SMTP_LOGIN"]
          smtp_password = os.environ["SMTP_PASSWORD"]
          from_email = os.environ["FROM_EMAIL"]

          with smtplib.SMTP(smtp_host, smtp_port) as server:
              server.starttls()
              server.login(smtp_login, smtp_password)

              for addr in recipients:
                  msg = MIMEText(email_body)
                  msg["Subject"] = email_subject
                  msg["From"] = from_email
                  msg["To"] = addr
                  server.sendmail(from_email, [addr], msg.as_string())
                  print("Sent to", addr)

          EOF */
